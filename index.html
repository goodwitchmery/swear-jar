<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Swear Jar</title>
  <style>
    body {
      background-color: black;
      color: orange;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      font-size: 2.5em;
      margin-top: 15vh;
      text-shadow: 0 0 15px #ffb000;
    }
    #counter {
      font-size: 8em;
      font-weight: bold;
      text-shadow: 0 0 20px #ff9900;
    }
    .button-container {
      margin-top: 30px;
    }
    button {
      background-color: orange;
      color: black;
      font-size: 1.2em;
      font-weight: bold;
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 10px #ff9900;
      transition: 0.2s;
    }
    button:hover {
      background-color: #ffb733;
    }
    button.active {
      background-color: #ffaa00;
    }
    #log {
      margin-top: 40px;
      font-size: 0.9em;
      color: #ccc;
      max-width: 80%;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>Swear count</h1>
  <div id="counter">0</div>

  <div class="button-container">
    <button id="listenBtn">üéôÔ∏è Start listening</button>
    <button id="resetBtn">‚ü≥ Reset</button>
  </div>

  <div id="log">Click "Start listening" to begin.</div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const workerURL = "https://swearjar.goodwitchmery.workers.dev";

      // --- JAR ID z URL ---
      const params = new URLSearchParams(window.location.search);
      const jarId = (params.get("jar") || "default").trim().toLowerCase();
      const storageKey = `swearCount:${jarId}`;

      const counterEl = document.getElementById("counter");
      const logEl = document.getElementById("log");
      const listenBtn = document.getElementById("listenBtn");
      const resetBtn = document.getElementById("resetBtn");

      let recognizing = false;
      let recognition = null;
      let currentCount = 0;

      const swearWords = [
        "fuck","fucking","motherfucker","mf","shit","bullshit","bastard","bitch","slut","whore",
        "ass","asshole","arse","arsehole","dick","dickhead","prick","cock","cocksucker",
        "cunt","twat","wanker","bollocks","bloody","damn","crap","jerk","douche","freak",
        "pussy","suck","sucks","sucker","fucker"
      ];

      function setCount(n) {
        currentCount = Number.isFinite(n) ? n : 0;
        counterEl.textContent = currentCount;
        localStorage.setItem(storageKey, String(currentCount));
      }

      function log(msg) {
        const ts = new Date().toLocaleTimeString();
        logEl.innerHTML = `[${ts}] ${msg}<br>` + logEl.innerHTML;
      }

      function countSwearsIn(text) {
        let delta = 0;
        const lower = text.toLowerCase();

        for (const w of swearWords) {
          const rx = new RegExp(`\\b${w.replace(/[.*+?^${}()|[\\]\\\\]/g, "\\$&")}\\b`, "gi");
          const m = lower.match(rx);
          if (m) delta += m.length;
        }

        const stars = lower.match(/\*{3,}/g);
        if (stars) delta += stars.length;

        return delta;
      }

      async function fetchCountFromWorker() {
        try {
          const r = await fetch(`${workerURL}/count?jar=${encodeURIComponent(jarId)}`, {
            cache: "no-store",
          });
          const j = await r.json();
          const workerCount = Number(j.count) || 0;

          const local = Number(localStorage.getItem(storageKey));
          const base = Number.isFinite(local) ? local : 0;

          const synced = Math.max(workerCount, base);
          setCount(synced);

          if (synced !== workerCount) {
            await saveCountToWorker(synced);
          }

          log(`Synced count from Worker (jar=${jarId}): ${synced}`);
        } catch (e) {
          console.error(e);
          const local = Number(localStorage.getItem(storageKey));
          if (Number.isFinite(local)) {
            setCount(local);
            log(`Worker unavailable, using local count: ${local}`);
          } else {
            setCount(0);
            log("Worker unavailable, starting from 0.");
          }
        }
      }

      async function saveCountToWorker(value) {
        // u≈ºywane przy sync ‚Äî nadpisuje liczbƒô w KV
        try {
          await fetch(`${workerURL}/reset?jar=${encodeURIComponent(jarId)}`, {
            method: "POST",
          });
          await fetch(`${workerURL}/increment?jar=${encodeURIComponent(jarId)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ delta: value }),
          });
        } catch (e) {
          console.error("saveCountToWorker failed", e);
        }
      }

      async function incrementCount(delta) {
        const safeDelta = Number(delta) || 0;
        if (safeDelta <= 0) return;

        try {
          const r = await fetch(`${workerURL}/increment?jar=${encodeURIComponent(jarId)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ delta: safeDelta }),
          });
          const j = await r.json();
          const newCount = Number(j.count);
          if (Number.isFinite(newCount)) {
            setCount(newCount);
          } else {
            setCount(currentCount + safeDelta);
          }
        } catch (e) {
          console.error(e);
          setCount(currentCount + safeDelta);
          log("Error incrementing on worker, saved locally.");
        }
      }

      async function resetCount() {
        try {
          const r = await fetch(`${workerURL}/reset?jar=${encodeURIComponent(jarId)}`, {
            method: "POST",
          });
          const j = await r.json();
          const newCount = Number(j.count) || 0;
          setCount(newCount);
          log("Counter reset (worker + local).");
        } catch (e) {
          console.error(e);
          setCount(0);
          log("Error resetting on worker, reset locally only.");
        }
      }

      async function startRecognition() {
        try {
          log("Requesting microphone access‚Ä¶");
          await navigator.mediaDevices.getUserMedia({ audio: true });
          log("Microphone access granted.");

          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SR) {
            log("Speech recognition not supported in this browser.");
            return;
          }

          recognition = new SR();
          recognition.lang = "en-US";
          recognition.continuous = true;
          recognition.interimResults = false;

          recognition.onstart = () => log("üéß Listening for English swears‚Ä¶");
          recognition.onerror = (ev) => {
            console.error(ev);
            log(`Recognition error: ${ev.error}`);
            if (
              recognizing &&
              (ev.error === "no-speech" || ev.error === "network" || ev.error === "aborted")
            ) {
              try { recognition.stop(); } catch (_) {}
              try { recognition.start(); } catch (_) {}
            }
          };

          recognition.onend = () => {
            if (recognizing) {
              log("Recognition ended, restarting‚Ä¶");
              try { recognition.start(); } catch (e) {
                console.error(e);
                log("Restart failed.");
              }
            }
          };

          recognition.onresult = async (ev) => {
            const res = ev.results[ev.results.length - 1][0];
            const text = (res.transcript || "").trim();
            if (!text) return;
            log(`Heard: ${text}`);
            const delta = countSwearsIn(text);
            if (delta > 0) {
              log(`ü§¨ Swear detected! +${delta}`);
              await incrementCount(delta);
            }
          };

          recognition.start();
          recognizing = true;
          listenBtn.classList.add("active");
          listenBtn.textContent = "‚è∏Ô∏è Pause";
        } catch (err) {
          console.error(err);
          log(`Start failed: ${err?.message || err}`);
        }
      }

      function stopRecognition() {
        recognizing = false;
        try { recognition && recognition.stop(); } catch (_) {}
        listenBtn.classList.remove("active");
        listenBtn.textContent = "üéôÔ∏è Start listening";
        log("Listening stopped.");
      }

      listenBtn.addEventListener("click", () =>
        recognizing ? stopRecognition() : startRecognition()
      );
      resetBtn.addEventListener("click", resetCount);

      // Start: wczytaj lokalny, potem zsynchronizuj z Workerem
      const saved = Number(localStorage.getItem(storageKey));
      if (Number.isFinite(saved) && saved > 0) {
        setCount(saved);
        log(`Loaded saved count for jar="${jarId}": ${saved}`);
      } else {
        setCount(0);
      }

      listenBtn.textContent = "üéôÔ∏è Start listening";
      log(`Click 'Start listening' to begin. (jar="${jarId}")`);

      fetchCountFromWorker();
    });
  </script>
</body>
</html>
